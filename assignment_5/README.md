# Assignment 5 <a name="assignment5"></a>

Note: Some portions of this README are adapted from the assignments provided to us by the Harvard CCB liaison team.

## Contents

<ol>
<li><a href="#desc">Description</a></li>
<li><a href="#anat">Anatomy of the MERFISH mouse ileum dataset</a></li>
<li><a href="#inst">Installation</a></li>
<li><a href="#scripts">Scripts</a></li>
<li><a href="#tasks">Tasks</a></li>
<li><a href="#exec">Execution</a></li>
</ol>

## Description <a name="desc"></a>

Note: This section is adapted from the assignments provided to us by the Harvard CCB liaison team.

Spatial transcriptomics protocols based on in situ sequencing or multiplexed RNA fluorescent hybridization can reveal detailed tissue organization. However, distinguishing the boundaries of individual cells in such data is challenging. Current segmentation methods typically approximate cell positions using nuclei stains.

[Petukhov et al., 2021](https://doi.org/10.1038/s41587-021-01044-w), describe [Baysor](https://github.com/kharchenkolab/Baysor), a segmentation method, which optimizes 2D or 3D cell boundaries considering joint likelihood of transcriptional composition and cell morphology. Baysor can also perform segmentation based on the detected transcripts alone.
Petukhov et al. compare the results of Baysor segmentation (mRNA-only) to the results of a deep learning-based segmentation method called [Cellpose](https://github.com/MouseLand/cellpose) from [Stringer et al., 2021](https://doi.org/10.1038/s41592-020-01018-x). Cellpose applies a machine learning framework for the segmentation of cell bodies, membranes and nuclei from microscopy images.
Petukhov et al. apply Baysor and Cellpose to MERFISH data from cryosections of mouse ileum (‘ileum’ is the final and longest segment of the small intestine). The MERFISH encoding probe library was designed to target 241 genes, including previously defined markers for the majority of gut cell types.

Samples in this dataset were stained with anti-Na+/K+-ATPase primary antibodies, oligo-labeled secondary antibodies and DAPI. MERFISH measurements across multiple fields of view and nine z planes were performed to provide a volumetric reconstruction of the distribution of the targeted mRNAs, the cell boundaries marked by Na+/K+-ATPase IF and cell nuclei stained with DAPI.

## Anatomy of the MERFISH mouse ileum dataset <a name="anat"></a>
<ul>
<li> Raw data </li>  
<ul>
<li> mRNA molecule data: 820k observations for 241 genes  </li>
<li> Image data: stitched 9-frame z-stacks (DAPI / Membrane, 500 MB) </li>
</ul>

<li> Processed data </li>
<ul>
<li> 3 different segmentations (Baysor, Cellpose, Baysor/Cellpose) </li>
<li> Cell clusters based on expression similarity  </li>
<li> Cell type labels based on marker gene expression in the clusters </li>
</ul>
</ul>

## Installation <a name="inst"></a>

The dataset can be obtained from the official [datadryad data publication](https://doi.org/10.5061/dryad.jm63xsjb2).

## Scripts <a name="scripts"></a>

Here follows a list of the source code we've included for this assignment.

* [compare_convex_hulls.py](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/compare_convex_hulls.py) - 
Python script for comparing the points from the original data with our computed convex hulls.

* [convexHullsAllLayers.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/convexHullsAllLayers.sql) -
SQL script for computing convex hulls for every cell in every z-layer.

* [createMoleculesAndCellsWithGeometries.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/createMoleculesAndCellsWithGeometries.sql) - 
SQL script for timing spatial interesect queries for all layers.

* [find_invalid_cells.py](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/find_invalid_cells.py) - 
Python script for identifying cells whose polygon representation is not a simple polygon

* [get_baysor_polygons.py](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/get_baysor_polygons.py) - 
Python script for parsing the given Baysor cell segmentation data JSON into a CSV

* [importCellPolygons.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/importCellPolygons.sql) - 
SQL script for importing the cell polygons CSV (generated by `get_baysor_polygons.py`) into a SQL database 

* [importCells.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/importCells.sql) - 
Deprecated

* [importMolecules.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/importMolecules.sql) - 
SQL script for importing the `molecules.csv` raw data into a SQL database

* [pivot.py](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/pivot.py) - 
Python script for ‘pivoting’ the gene expression table into a gene expression matrix

* [polygonProcessing.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/polygonProcessing.sql) - 
Deprecated

* [processCellPolygons.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/processCellPolygons.sql) - 
SQL script for parsing the imported CellPolygons table (with polygons represented as strings) and creating a geometry type polygon column

* [processMoleculesPoints.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/processMoleculesPoints.sql) -
SQL script for parsing the imported Molecules table (with points represented as strings) and creating a geometry type point column

* [processSegmentationPoints.sql](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/processSegmentationPoints.sql) - 
SQL script that preprocesses segmentation.csv after the bulk insert

* [visualize_cells.py](https://github.com/kunyanglu/harvard-ccb-hmc-clinic/blob/main/assignment_5/src/visualize_cells.py)
Python script that uses `poly_per_z.json` to draw plots of cell polygons from the Baysor segmentation


## Tasks <a name="tasks"></a>

Note: This section is adapted from the assignments provided to us by the Harvard CCB liaison team.

1. Obtain the dataset from [datadryad](https://doi.org/10.5061/dryad.jm63xsjb2) and inspect the contents of the data release. Use the contained README for an orientation. There are two relevant parts here for us in the beginning: 1) the molecule data table in raw_data /molecules.csv, and 2) the cell polygon coordinates from the Baysor segmentation in `data_analysis/baysor/segmentation/poly_per_z.json`.

2. Create an SQL table for both data components, i.e. 1) one table representing the molecules as spatial points given their x, y, and z-coordinates (using the pixel coordinates), and 2) one table representing the cells as polygons. It is a good exercise to create the cell polygon table directly from the json format. Alternatively, the cell polygon coordinates in a flattened 2D table format can be obtained from [dropbox](https://www.dropbox.com/s/n6rf3sastdo9fn5/baysor_polygons.csv?dl=0). 

3. Perform spatial overlap queries between the molecule table and the cell polygon table to create a new SQL table. The resulting table should contain three columns (gene, cell, molecule count) and store for each gene the number of molecules overlapping with each cell. Also record the execution time of your queries to produce this molecule count table (best to calculate average execution time from performing queries repeatedly).

4. Reshape the molecule count table to a two-dimensional expression matrix (gene x cell). The resulting expression matrix should store for each gene the number of molecules overlapping with each cell. This will involve a pivot operation in the database and can alternatively also be performed in R/Python based on the molecule count table produced in 3.

5. We proceed by inspecting the molecule to cell assignment for the Baysor segmentation in data_analysis/baysor/segmentation/segmentation.csv. One issue with the polygon coordinates in the json file is that there is no 1:1 mapping between these polygons and the cell metadata. We therefore aim to reconstruct the cell boundaries by computing [convex hulls](https://learn.microsoft.com/en-us/sql/t-sql/spatial-geometry/stconvexhull-geometry-data-type?view=sql-server-ver16) around all molecules assigned to a cell. As before: record the average execution time of your queries to produce a table of convex hull geometries for each of the 5800 cells in the segmentation csv file. 

## Execution <a name="exec"></a>

To run our code for this assignment, follow along in our [Summarized Notebook](Notebooks/Assignment5NotebookSummarized.ipynb). 
The other notebooks (Assignment5NotebookPart1 and Assignment5NotebookPart2) are intended as a catalog of our thought process and can be ignored.

